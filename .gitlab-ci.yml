stages:
  - linting
  - unit-tests
  - deploy

linting:
  stage: linting
  image: python
  script:
    - pip install black
    - black --check .

unit-tests:
  stage: unit-tests
  image: docker:24.0.7
  tags:
    - dind
  services:
    - docker:24.0.7-dind
  script:
    - docker compose -f tests/docker-compose.unit_tests.yaml up --build --exit-code-from unit_tests
  rules:
    - when: always  

deploy:
  image: docker:latest
  stage: deploy
  tags:
    - deploy
  script:
    - echo "$SSH_PRIVATE_KEY" > ssh_private_key
    - chmod 400 ssh_private_key
    - cp $CONFIG_FILE config.yaml
    - 'echo "PTAH_ACCESS_TOKEN="$PTAH_ACCESS_TOKEN >> .env'
    - ssh -i ssh_private_key -o StrictHostKeyChecking=no $VM_USER@$VM_IP "rm -rf /opt/hermes/*"
    - scp -i ssh_private_key -o StrictHostKeyChecking=no -r ./* ${VM_USER}@${VM_IP}:/opt/hermes/
    - scp -i ssh_private_key -o StrictHostKeyChecking=no -r ./.env ${VM_USER}@${VM_IP}:/opt/hermes/
    - ssh -i ssh_private_key -o StrictHostKeyChecking=no $VM_USER@$VM_IP "cd /opt/hermes &&
      docker compose stop &&
      docker compose rm -f &&
      docker compose up -d --build"
    - rm .env
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
