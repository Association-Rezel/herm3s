stages:
  - linting
  - unit-tests
  - deploy

linting:
  stage: linting
  image: python
  script:
    - pip install black
    - black --check .

unit-tests:
  stage: unit-tests
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  script:
    - docker compose -f docker-compose.unit_tests.yaml up --build --exit-code-from unit_tests
  rules:
    - when: always  

deploy:
  image: docker:latest
  stage: deploy
  tags:
    - deploy
  script:
    - echo "$SSH_PRIVATE_KEY" > ssh_private_key
    - chmod 400 ssh_private_key
    - scp -i ssh_private_key -o StrictHostKeyChecking=no -r ./* ${VM_USER}@${VM_IP}:/opt/hermes/
    - ssh -i ssh_private_key -o StrictHostKeyChecking=no $VM_USER@$VM_IP "cd /opt/hermes &&
      docker compose stop &&
      docker compose rm -f &&
      docker compose up -d --build"
