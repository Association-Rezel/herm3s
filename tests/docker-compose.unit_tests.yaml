services:
  api_hermes:
    container_name: test_api_hermes
    build: ..
    env_file:
      - .env.tests
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://test_api_hermes:8000/status"]
      interval: 2s
      timeout: 5s
      retries: 10

  mongodb:
    container_name: test_mongodb
    image: mongodb/mongodb-community-server:latest
    ports:
      - "27017:27017"

  mongodb-import:
    container_name: test_mongodb-import
    image: mongodb/mongodb-community-server:latest
    links:
      - mongodb
    volumes:
      - ./mongodb-import:/mongodb-import:Z
    command: >
      bash -c '
      mongoimport --host test_mongodb --db test --collection boxes --type json --file /mongodb-import/test.boxes.json --jsonArray && sleep infinity'

  unit_tests:
    container_name: unit_tests
    depends_on:
      api_hermes:
        condition: service_healthy
    build:
      context: .
      dockerfile: Dockerfile.unit_tests
    env_file: .env.tests
    environment:
      - URL=http://test_api_hermes:8000
